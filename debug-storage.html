<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Storage - Crypto Wallet</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      padding: 20px;
      background: #1e1e1e;
      color: #d4d4d4;
    }
    h1 {
      color: #667eea;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #764ba2;
    }
    pre {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .section {
      margin: 20px 0;
      border: 1px solid #444;
      padding: 15px;
      border-radius: 5px;
    }
    .label {
      color: #667eea;
      font-weight: bold;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>üîç Debug Storage - Crypto Wallet</h1>
  <p>Outil de d√©bogage pour inspecter le storage de l'extension</p>

  <div>
    <button onclick="loadStorage()">Recharger le Storage</button>
    <button onclick="testCurrentAccount()">Tester getCurrentAccount</button>
    <button onclick="clearOutput()">Effacer</button>
    <button onclick="resetWallet()" style="background: #dc3545;">‚ö†Ô∏è Reset Wallet</button>
  </div>

  <div style="background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin: 20px 0;">
    <strong>‚ö†Ô∏è Note importante:</strong>
    Si vous avez cr√©√© un wallet avant la correction du bug, vous devez le r√©initialiser.
    Cliquez sur "Reset Wallet" puis recr√©ez un nouveau wallet dans l'extension.
  </div>

  <div class="section">
    <div class="label">√âtat du Wallet:</div>
    <pre id="wallet-output">Cliquez sur "Recharger le Storage" pour voir les donn√©es...</pre>
  </div>

  <div class="section">
    <div class="label">Networks:</div>
    <pre id="networks-output">-</pre>
  </div>

  <div class="section">
    <div class="label">State:</div>
    <pre id="state-output">-</pre>
  </div>

  <div class="section">
    <div class="label">Current Account (via message):</div>
    <pre id="current-account-output">-</pre>
  </div>

  <script>
    async function sendMessage(type, payload) {
      return new Promise((resolve, reject) => {
        chrome.runtime.sendMessage({ type, payload }, (response) => {
          if (chrome.runtime.lastError) {
            reject(new Error(chrome.runtime.lastError.message));
          } else if (response?.success) {
            resolve(response.data);
          } else {
            reject(new Error(response?.error || 'Request failed'));
          }
        });
      });
    }

    async function loadStorage() {
      try {
        // Get all storage data
        const allData = await chrome.storage.local.get(null);

        // Display wallet
        if (allData.wallet) {
          const wallet = allData.wallet;
          const displayWallet = {
            hasEncryptedMnemonic: !!wallet.encryptedMnemonic,
            mnemonicLength: wallet.encryptedMnemonic?.length || 0,
            accountsCount: wallet.accounts?.length || 0,
            accounts: wallet.accounts?.map((acc, idx) => ({
              index: idx,
              address: acc.address,
              derivationPath: acc.derivationPath,
              hasDerivationPath: !!acc.derivationPath,
              publicKey: acc.publicKey?.substring(0, 20) + '...'
            })),
            createdAt: new Date(wallet.createdAt).toLocaleString()
          };
          document.getElementById('wallet-output').textContent = JSON.stringify(displayWallet, null, 2);
        } else {
          document.getElementById('wallet-output').textContent = 'Aucun wallet trouv√©';
        }

        // Display networks
        if (allData.networks) {
          document.getElementById('networks-output').textContent = JSON.stringify(allData.networks, null, 2);
        } else {
          document.getElementById('networks-output').textContent = 'Aucun r√©seau trouv√©';
        }

        // Display state
        if (allData.state) {
          document.getElementById('state-output').textContent = JSON.stringify(allData.state, null, 2);
        } else {
          document.getElementById('state-output').textContent = 'Aucun state trouv√©';
        }
      } catch (error) {
        document.getElementById('wallet-output').textContent = `Erreur: ${error.message}`;
      }
    }

    async function testCurrentAccount() {
      try {
        const account = await sendMessage('GET_CURRENT_ACCOUNT');
        document.getElementById('current-account-output').textContent = JSON.stringify(account, null, 2);
      } catch (error) {
        document.getElementById('current-account-output').textContent = `Erreur: ${error.message}`;
      }
    }

    function clearOutput() {
      document.getElementById('wallet-output').textContent = '';
      document.getElementById('networks-output').textContent = '';
      document.getElementById('state-output').textContent = '';
      document.getElementById('current-account-output').textContent = '';
    }

    async function resetWallet() {
      if (!confirm('‚ö†Ô∏è ATTENTION ‚ö†Ô∏è\n\nCela va supprimer TOUTES les donn√©es du wallet !\n\nAssurez-vous d\'avoir sauvegard√© votre phrase de r√©cup√©ration si vous voulez restaurer ce wallet plus tard.\n\nContinuer ?')) {
        return;
      }

      if (!confirm('√ätes-vous VRAIMENT s√ªr ? Cette action est irr√©versible !')) {
        return;
      }

      try {
        await chrome.storage.local.clear();
        await chrome.storage.session.clear();
        alert('‚úÖ Wallet r√©initialis√© avec succ√®s !\n\nRechargez l\'extension puis cr√©ez un nouveau wallet.');
        loadStorage();
      } catch (error) {
        alert(`‚ùå Erreur: ${error.message}`);
      }
    }

    // Auto-load on page load
    window.addEventListener('load', loadStorage);
  </script>
</body>
</html>
