<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Crypto Wallet</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 32px;
    }

    .subtitle {
      color: #888;
      margin-bottom: 40px;
      font-size: 16px;
    }

    .status {
      background: #f7f7f7;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .status-item:last-child {
      border-bottom: none;
    }

    .status-label {
      font-weight: 600;
      color: #333;
    }

    .status-value {
      color: #667eea;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }

    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 10px 10px 10px 0;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }

    .button:active {
      transform: translateY(0);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .button-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      box-shadow: none;
    }

    .section {
      margin: 30px 0;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
    }

    .input-group {
      margin: 15px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .input-group input:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    #output {
      background: #f7f7f7;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      min-height: 100px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      color: #333;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .success {
      color: #28a745;
      font-weight: 600;
    }

    .error {
      color: #dc3545;
      font-weight: 600;
    }

    .warning {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      color: #856404;
    }

    .warning strong {
      display: block;
      margin-bottom: 5px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Test DApp - Crypto Wallet</h1>
    <p class="subtitle">Testez votre extension de wallet crypto</p>

    <div class="warning">
      <strong>‚ö†Ô∏è Avertissement</strong>
      Ceci est une page de test pour votre wallet crypto. N'envoyez jamais de vraies crypto-monnaies vers des adresses de test.
    </div>

    <div class="status">
      <div class="status-item">
        <span class="status-label">√âtat du wallet:</span>
        <span class="status-value" id="wallet-status">Non d√©tect√©</span>
      </div>
      <div class="status-item">
        <span class="status-label">Adresse connect√©e:</span>
        <span class="status-value" id="connected-address">Aucune</span>
      </div>
      <div class="status-item">
        <span class="status-label">Chain ID:</span>
        <span class="status-value" id="chain-id">-</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Connexion</div>
      <div class="grid">
        <button class="button" id="connect-btn" onclick="connectWallet()">Connecter le Wallet</button>
        <button class="button button-secondary" id="disconnect-btn" onclick="disconnect()" disabled>D√©connecter</button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Signature de Message</div>
      <div class="input-group">
        <label for="message-input">Message √† signer:</label>
        <input type="text" id="message-input" value="Hello Web3!" placeholder="Entrez un message">
      </div>
      <button class="button" onclick="signMessage()" id="sign-btn" disabled>Signer le Message</button>
    </div>

    <div class="section">
      <div class="section-title">Test de Transaction</div>
      <div class="input-group">
        <label for="to-address">Adresse destinataire:</label>
        <input type="text" id="to-address" placeholder="0x..." value="0x0000000000000000000000000000000000000000">
      </div>
      <div class="input-group">
        <label for="amount">Montant (ETH):</label>
        <input type="text" id="amount" placeholder="0.001" value="0.001">
      </div>
      <button class="button" onclick="sendTransaction()" id="send-btn" disabled>Envoyer (Test)</button>
      <p style="color: #888; font-size: 12px; margin-top: 10px;">
        Note: Ceci ne fonctionnera que si vous √™tes sur un r√©seau de test avec des fonds de test
      </p>
    </div>

    <div class="section">
      <div class="section-title">Test Smart Contract - ERC20 Transfer</div>
      <div class="input-group">
        <label for="token-address">Adresse du token ERC20:</label>
        <input type="text" id="token-address" placeholder="0x..." value="">
      </div>
      <div class="input-group">
        <label for="token-recipient">Adresse destinataire:</label>
        <input type="text" id="token-recipient" placeholder="0x..." value="0x0000000000000000000000000000000000000000">
      </div>
      <div class="input-group">
        <label for="token-amount">Montant (tokens):</label>
        <input type="text" id="token-amount" placeholder="1.0" value="1.0">
      </div>
      <div class="grid">
        <button class="button button-secondary" onclick="getTokenBalance()" id="check-balance-btn" disabled>V√©rifier Solde</button>
        <button class="button" onclick="transferToken()" id="transfer-btn" disabled>Transf√©rer Token</button>
      </div>
      <p style="color: #888; font-size: 12px; margin-top: 10px;">
        Exemples de tokens testnet (Polygon Mumbai): USDC, DAI, etc.<br>
        Note: Vous devez avoir des tokens de test dans votre wallet
      </p>
    </div>

    <div class="section">
      <div class="section-title">Test Aave V3 Supply</div>
      <div class="input-group">
        <label for="aave-token-address">Adresse du token √† d√©poser:</label>
        <input type="text" id="aave-token-address" placeholder="0x..." value="0x29f2D40B0605204364af54EC677bD022dA425d03">
        <small style="color: #888;">Exemple: WBTC Sepolia</small>
      </div>
      <div class="input-group">
        <label for="aave-pool-address">Adresse Aave Pool:</label>
        <input type="text" id="aave-pool-address" placeholder="0x..." value="0x6Ae43d3271ff6888e7Fc43Fd7321a503ff738951">
        <small style="color: #888;">Aave V3 Pool Sepolia</small>
      </div>
      <div class="input-group">
        <label for="aave-amount">Montant √† d√©poser:</label>
        <input type="text" id="aave-amount" placeholder="0.01" value="0.01">
      </div>
      <div class="grid">
        <button class="button button-secondary" onclick="checkAavePosition()" id="check-aave-btn" disabled>V√©rifier Position Aave</button>
        <button class="button button-secondary" onclick="approveAavePool()" id="approve-aave-btn" disabled>Approuver Aave Pool</button>
        <button class="button" onclick="supplyToAave()" id="supply-aave-btn" disabled>D√©poser sur Aave</button>
      </div>
      <div id="aave-position" style="background: #f7f7f7; border-radius: 8px; padding: 15px; margin-top: 15px; display: none;">
        <div style="font-weight: 600; margin-bottom: 10px;">Position Aave:</div>
        <div style="font-family: 'Courier New', monospace; font-size: 13px;">
          <div>Collateral Total: <span id="aave-collateral">-</span> USD</div>
          <div>Dette Totale: <span id="aave-debt">-</span> USD</div>
          <div>Health Factor: <span id="aave-health">-</span></div>
        </div>
      </div>
      <p style="color: #888; font-size: 12px; margin-top: 10px;">
        Testez le d√©p√¥t sur Aave V3. Le processus inclut l'approbation du token puis le d√©p√¥t.<br>
        Note: N√©cessite des tokens de test sur Sepolia
      </p>
    </div>

    <div class="section">
      <div class="section-title">Informations du Provider</div>
      <button class="button button-secondary" onclick="getProviderInfo()">R√©cup√©rer les infos</button>
    </div>

    <div class="section">
      <div class="section-title">R√©sultat</div>
      <div id="output">Les r√©sultats s'afficheront ici...</div>
    </div>
  </div>

  <script>
    let currentAccount = null;

    // V√©rifier si le wallet est install√©
    window.addEventListener('load', () => {
      if (typeof window.ethereum !== 'undefined') {
        log('‚úÖ Wallet d√©tect√©!', 'success');
        document.getElementById('wallet-status').textContent = 'D√©tect√©';

        // √âcouter les changements de compte
        window.ethereum.on('accountsChanged', handleAccountsChanged);
        window.ethereum.on('chainChanged', handleChainChanged);
      } else {
        log('‚ùå Aucun wallet d√©tect√©. Installez l\'extension!', 'error');
        document.getElementById('wallet-status').textContent = 'Non install√©';
      }
    });

    async function connectWallet() {
      try {
        log('üîó Connexion au wallet...');
        const accounts = await window.ethereum.request({
          method: 'eth_requestAccounts'
        });

        handleAccountsChanged(accounts);
        log('‚úÖ Connect√© avec succ√®s!', 'success');

        // R√©cup√©rer le chain ID
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        document.getElementById('chain-id').textContent = chainId;

      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    function disconnect() {
      currentAccount = null;
      document.getElementById('connected-address').textContent = 'Aucune';
      document.getElementById('connect-btn').disabled = false;
      document.getElementById('disconnect-btn').disabled = true;
      document.getElementById('sign-btn').disabled = true;
      document.getElementById('send-btn').disabled = true;
      document.getElementById('check-balance-btn').disabled = true;
      document.getElementById('transfer-btn').disabled = true;
      document.getElementById('check-aave-btn').disabled = true;
      document.getElementById('approve-aave-btn').disabled = true;
      document.getElementById('supply-aave-btn').disabled = true;
      log('üîå D√©connect√©');
    }

    async function signMessage() {
      if (!currentAccount) {
        log('‚ùå Connectez d\'abord votre wallet', 'error');
        return;
      }

      try {
        const message = document.getElementById('message-input').value;
        log(`üìù Signature du message: "${message}"`);

        const signature = await window.ethereum.request({
          method: 'personal_sign',
          params: [message, currentAccount]
        });

        log(`‚úÖ Signature g√©n√©r√©e:\n${signature.toString()}`, 'success');
      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    async function sendTransaction() {
      if (!currentAccount) {
        log('‚ùå Connectez d\'abord votre wallet', 'error');
        return;
      }

      try {
        const to = document.getElementById('to-address').value;
        const amount = document.getElementById('amount').value;

        log(`üí∏ Envoi de ${amount} ETH vers ${to}...`);

        const transactionParameters = {
          from: currentAccount,
          to: to,
          value: '0x' + (parseFloat(amount) * 1e18).toString(16),
        };

        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [transactionParameters],
        });

        log(`‚úÖ Transaction envoy√©e!\nHash: ${txHash}`, 'success');
      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    async function getProviderInfo() {
      try {
        log('üìä Informations du provider:');

        const info = {
          'isMetaMask': window.ethereum.isMetaMask,
          'isCryptoWallet': window.ethereum.isCryptoWallet,
          'chainId': await window.ethereum.request({ method: 'eth_chainId' }),
          'networkVersion': window.ethereum.networkVersion,
        };

        if (currentAccount) {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          info['accounts'] = accounts;
        }

        log(JSON.stringify(info, null, 2));
      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    async function getTokenBalance() {
      if (!currentAccount) {
        log('‚ùå Connectez d\'abord votre wallet', 'error');
        return;
      }

      try {
        const tokenAddress = document.getElementById('token-address').value;
        if (!tokenAddress || !tokenAddress.startsWith('0x')) {
          log('‚ùå Adresse de token invalide', 'error');
          return;
        }

        log(`üîç V√©rification du solde pour ${tokenAddress}...`);

        // Encode balanceOf(address) call - function selector: 0x70a08231
        const balanceOfData = '0x70a08231000000000000000000000000' + currentAccount.slice(2);

        const balance = await window.ethereum.request({
          method: 'eth_call',
          params: [{
            to: tokenAddress,
            data: balanceOfData
          }, 'latest']
        });

        // Get decimals
        const decimalsData = '0x313ce567'; // decimals()
        const decimalsResult = await window.ethereum.request({
          method: 'eth_call',
          params: [{
            to: tokenAddress,
            data: decimalsData
          }, 'latest']
        });

        const decimals = parseInt(decimalsResult, 16);
        const balanceNum = parseInt(balance, 16);
        const formattedBalance = (balanceNum / Math.pow(10, decimals)).toFixed(6);

        log(`‚úÖ Solde: ${formattedBalance} tokens (${balanceNum} wei)\nDecimals: ${decimals}`, 'success');
      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    async function transferToken() {
      if (!currentAccount) {
        log('‚ùå Connectez d\'abord votre wallet', 'error');
        return;
      }

      try {
        const tokenAddress = document.getElementById('token-address').value;
        const recipient = document.getElementById('token-recipient').value;
        const amount = document.getElementById('token-amount').value;

        if (!tokenAddress || !tokenAddress.startsWith('0x')) {
          log('‚ùå Adresse de token invalide', 'error');
          return;
        }

        if (!recipient || !recipient.startsWith('0x')) {
          log('‚ùå Adresse destinataire invalide', 'error');
          return;
        }

        log(`üì§ Transfert de ${amount} tokens vers ${recipient}...`);

        // Get token decimals first
        const decimalsData = '0x313ce567'; // decimals()
        const decimalsResult = await window.ethereum.request({
          method: 'eth_call',
          params: [{
            to: tokenAddress,
            data: decimalsData
          }, 'latest']
        });

        const decimals = parseInt(decimalsResult, 16);
        const amountInWei = BigInt(Math.floor(parseFloat(amount) * Math.pow(10, decimals)));

        // ERC20 transfer function signature: transfer(address,uint256)
        // Function selector: 0xa9059cbb
        const transferData =
          '0xa9059cbb' +
          recipient.slice(2).padStart(64, '0') +
          amountInWei.toString(16).padStart(64, '0');

        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from: currentAccount,
            to: tokenAddress,
            data: transferData,
            value: '0x0'
          }]
        });

        log(`‚úÖ Transaction envoy√©e!\nHash: ${txHash}\nMontant: ${amount} tokens\nDestinataire: ${recipient}`, 'success');
      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        disconnect();
      } else if (accounts[0] !== currentAccount) {
        currentAccount = accounts[0];
        const shortAddress = `${currentAccount.slice(0, 6)}...${currentAccount.slice(-4)}`;
        document.getElementById('connected-address').textContent = shortAddress;
        document.getElementById('connect-btn').disabled = true;
        document.getElementById('disconnect-btn').disabled = false;
        document.getElementById('sign-btn').disabled = false;
        document.getElementById('send-btn').disabled = false;
        document.getElementById('check-balance-btn').disabled = false;
        document.getElementById('transfer-btn').disabled = false;
        document.getElementById('check-aave-btn').disabled = false;
        document.getElementById('approve-aave-btn').disabled = false;
        document.getElementById('supply-aave-btn').disabled = false;
        log(`üîÑ Compte chang√©: ${currentAccount}`);
      }
    }

    // Aave V3 functions
    async function checkAavePosition() {
      if (!currentAccount) {
        log('‚ùå Connectez d\'abord votre wallet', 'error');
        return;
      }

      try {
        const aavePoolAddress = document.getElementById('aave-pool-address').value;
        if (!aavePoolAddress || !aavePoolAddress.startsWith('0x')) {
          log('‚ùå Adresse Aave Pool invalide', 'error');
          return;
        }

        log('üîç V√©rification de la position Aave...');

        // Aave V3 Pool ABI: getUserAccountData(address)
        // Function selector: 0xbf92857c
        const getUserAccountDataSelector = '0xbf92857c';
        const accountData = getUserAccountDataSelector + currentAccount.slice(2).padStart(64, '0');

        const result = await window.ethereum.request({
          method: 'eth_call',
          params: [{
            to: aavePoolAddress,
            data: accountData
          }, 'latest']
        });

        // Parse result (6 uint256 values)
        const totalCollateralBase = BigInt('0x' + result.slice(2, 66));
        const totalDebtBase = BigInt('0x' + result.slice(66, 130));
        const availableBorrowsBase = BigInt('0x' + result.slice(130, 194));
        const currentLiquidationThreshold = BigInt('0x' + result.slice(194, 258));
        const ltv = BigInt('0x' + result.slice(258, 322));
        const healthFactor = BigInt('0x' + result.slice(322, 386));

        // Format values (Aave uses 8 decimals for USD values)
        const collateralUSD = (Number(totalCollateralBase) / 1e8).toFixed(2);
        const debtUSD = (Number(totalDebtBase) / 1e8).toFixed(2);
        const healthFactorFormatted = healthFactor > 0n
          ? (Number(healthFactor) / 1e18).toFixed(2)
          : '‚àû';

        // Update UI
        document.getElementById('aave-collateral').textContent = collateralUSD;
        document.getElementById('aave-debt').textContent = debtUSD;
        document.getElementById('aave-health').textContent = healthFactorFormatted;
        document.getElementById('aave-position').style.display = 'block';

        log(`‚úÖ Position Aave r√©cup√©r√©e:\n  Collateral: ${collateralUSD} USD\n  Debt: ${debtUSD} USD\n  Health Factor: ${healthFactorFormatted}`, 'success');
      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
        console.error('Aave position error:', error);
      }
    }

    async function approveAavePool() {
      if (!currentAccount) {
        log('‚ùå Connectez d\'abord votre wallet', 'error');
        return;
      }

      try {
        const tokenAddress = document.getElementById('aave-token-address').value;
        const aavePoolAddress = document.getElementById('aave-pool-address').value;
        const amount = document.getElementById('aave-amount').value;

        if (!tokenAddress || !tokenAddress.startsWith('0x')) {
          log('‚ùå Adresse de token invalide', 'error');
          return;
        }

        if (!aavePoolAddress || !aavePoolAddress.startsWith('0x')) {
          log('‚ùå Adresse Aave Pool invalide', 'error');
          return;
        }

        log(`üìù Approbation du token pour Aave Pool...`);

        // Get token decimals
        const decimalsData = '0x313ce567'; // decimals()
        const decimalsResult = await window.ethereum.request({
          method: 'eth_call',
          params: [{
            to: tokenAddress,
            data: decimalsData
          }, 'latest']
        });

        const decimals = parseInt(decimalsResult, 16);
        const amountInWei = BigInt(Math.floor(parseFloat(amount) * Math.pow(10, decimals)));

        // ERC20 approve function: approve(address,uint256)
        // Function selector: 0x095ea7b3
        const approveData =
          '0x095ea7b3' +
          aavePoolAddress.slice(2).padStart(64, '0') +
          amountInWei.toString(16).padStart(64, '0');

        log(`  Montant: ${amount} (${amountInWei.toString()} wei)\n  Spender: ${aavePoolAddress}`);

        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from: currentAccount,
            to: tokenAddress,
            data: approveData,
            value: '0x0'
          }]
        });

        log(`‚úÖ Approbation envoy√©e!\nHash: ${txHash}`, 'success');
      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
        console.error('Approve error:', error);
      }
    }

    async function supplyToAave() {
      if (!currentAccount) {
        log('‚ùå Connectez d\'abord votre wallet', 'error');
        return;
      }

      try {
        const tokenAddress = document.getElementById('aave-token-address').value;
        const aavePoolAddress = document.getElementById('aave-pool-address').value;
        const amount = document.getElementById('aave-amount').value;
        const moduleAddress = '0x42FBd804C677324c4b711Fce26Ee8226702B389A'; // DeFi Interactor Module

        if (!tokenAddress || !tokenAddress.startsWith('0x')) {
          log('‚ùå Adresse de token invalide', 'error');
          return;
        }

        if (!aavePoolAddress || !aavePoolAddress.startsWith('0x')) {
          log('‚ùå Adresse Aave Pool invalide', 'error');
          return;
        }

        log(`üí∞ D√©p√¥t sur Aave V3 via Module...`);

        const decimals = 8; // parseInt(decimalsResult, 16);
        const amountInWei = BigInt(Math.floor(parseFloat(amount) * Math.pow(10, decimals)));

        // Step 1: Encode Aave supply call
        // supply(address asset, uint256 amount, address onBehalfOf, uint16 referralCode)
        // Function selector: 0x617ba037
        const aaveSupplyData =
          '0x617ba037' +
          tokenAddress.slice(2).padStart(64, '0') +           // asset
          amountInWei.toString(16).padStart(64, '0') +         // amount
          currentAccount.slice(2).padStart(64, '0') +          // onBehalfOf
          '0'.padStart(64, '0');                               // referralCode (0)

        // Step 2: Encode executeOnProtocol call
        // executeOnProtocol(address target, bytes calldata data)
        // Function selector: 0x18c0bb0e
        const aaveSupplyBytes = aaveSupplyData.slice(2); // Remove 0x
        const bytesLength = (aaveSupplyBytes.length / 2).toString(16).padStart(64, '0');

        const executeData =
          '0x18c0bb0e' +                                       // executeOnProtocol selector
          aavePoolAddress.slice(2).padStart(64, '0') +         // target (Aave Pool)
          '0000000000000000000000000000000000000000000000000000000000000040' + // offset to bytes (64)
          bytesLength +                                        // length of bytes data
          aaveSupplyBytes +                                    // the Aave supply call data
          (aaveSupplyBytes.length % 64 !== 0 ? '0'.repeat(64 - (aaveSupplyBytes.length % 64)) : ''); // padding

        log(`  Module: ${moduleAddress}\n  Token: ${tokenAddress}\n  Montant: ${amount} (${amountInWei.toString()} wei)\n  Destinataire: ${currentAccount}`);

        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from: "0x7edA8eE795988aC0FfC5C6A50B2C6798613900BB",
            to: moduleAddress,  // Call module instead of Aave
            data: executeData,
            value: '0x0'
          }]
        }).catch(error => {
          log(`‚ùå Erreur: ${error.message}`, 'error');
          console.error('Supply error:', error);
        });

        log(`‚úÖ D√©p√¥t Aave envoy√© via Module!\nHash: ${txHash}\n\nAttendez la confirmation puis v√©rifiez votre position avec "V√©rifier Position Aave"`, 'success');

        // Auto-refresh position after a delay
        setTimeout(() => {
          log('üîÑ Rafra√Æchissement automatique de la position...');
          checkAavePosition();
        }, 5000);

      } catch (error) {
        log(`‚ùå Erreur: ${error.message}`, 'error');
        console.error('Supply error:', error);
      }
    }

    function handleChainChanged(chainId) {
      document.getElementById('chain-id').textContent = chainId;
      log(`üîÑ R√©seau chang√©: ${chainId}`);
    }

    function log(message, type = '') {
      const output = document.getElementById('output');
      const timestamp = new Date().toLocaleTimeString();
      const className = type ? `class="${type}"` : '';
      output.innerHTML = `<span ${className}>[${timestamp}] ${message}</span>\n${output.innerHTML}`;
    }
  </script>
</body>
</html>
